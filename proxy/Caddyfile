# 8001 → Vaultwarden (unchanged)
:8001 {
  encode gzip
  handle {
    reverse_proxy 127.0.0.1:11002  # Must match the new port above
  }
}

# 8002 → Actual at site root "/"
:8002 {
  encode gzip
  header {
    # Needed for SAB/wasm
    Cross-Origin-Opener-Policy "same-origin"
    Cross-Origin-Embedder-Policy "require-corp"
    # Recommended hardening
    Cross-Origin-Resource-Policy "same-origin"
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Referrer-Policy "no-referrer"
    Permissions-Policy "interest-cohort=()"
  }
  reverse_proxy 127.0.0.1:5006
}

# 8003 → Nextcloud AIO (via internal port 11000)
:8003 {
  encode gzip

  # Nextcloud specific headers for security and performance
  header {
    Strict-Transport-Security "max-age=15552000; includeSubDomains"
    # Ensure Nextcloud knows it is being proxied
    X-Forwarded-Proto "https"
  }

  # Increase buffer size for large file uploads
  request_body {
     max_size 10GB
  }

  reverse_proxy 127.0.0.1:11000 {
     # Important for Nextcloud to recognize the proxy
     header_up Host {host}
     header_up X-Real-IP {remote}
  }
}
